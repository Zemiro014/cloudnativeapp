name: CI Monorepo (Docker)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ====================================================
  # JOB 1: TESTES E VERIFICAÇÃO (Em Paralelo)
  # ====================================================
  quality-check:
    name: Test ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Define quais pastas vamos testar
        service: [backend, frontend]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          # Importante: Aponta para o lockfile ESPECÍFICO de cada pasta para o cache funcionar
          cache-dependency-path: ${{ matrix.service }}/package-lock.json

      - name: Install Dependencies
        # Entra na pasta do serviço (backend ou frontend) e instala
        run: |
          cd ${{ matrix.service }}
          npm ci

      - name: Run Tests
        # Roda os testes apenas se existir script de test no package.json daquela pasta
        run: |
          cd ${{ matrix.service }}
          if grep -q "\"test\"" package.json; then
            npm test
          else
            echo "⚠️ Skipping tests: No test script found in ${{ matrix.service }}"
          fi

      - name: Run Lint
        run: |
          cd ${{ matrix.service }}
          if grep -q "\"lint\"" package.json; then
            npm run lint
          fi

  # ====================================================
  # JOB 2: BUILD DAS IMAGENS DOCKER
  # ====================================================
  build-images:
    needs: quality-check # Só tenta buildar se os testes passarem
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Configura o QEMU (caso precise de multi-arquitetura, ex: linux/arm64)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Configura o Docker Buildx (Essencial para Cache do GitHub Actions)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ----------------------------------------------------------------
      # BUILD BACKEND
      # ----------------------------------------------------------------
      - name: Build Backend Image
        uses: docker/build-push-action@v5
        with:
          # O PULO DO GATO ESTÁ AQUI:
          context: ./backend        # O Docker vai "enxergar" apenas a pasta backend como raiz
          file: ./backend/Dockerfile # Aponta onde está o arquivo
          push: false               # Mude para 'true' quando configurar AWS ECR / DockerHub
          tags: my-backend:latest
          # Cache inteligente do GitHub Actions (acelera muito o build)
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      # ----------------------------------------------------------------
      # BUILD FRONTEND
      # ----------------------------------------------------------------
      - name: Build Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend       # O Docker vai "enxergar" apenas a pasta frontend como raiz
          file: ./frontend/Dockerfile
          push: false
          tags: my-frontend:latest
          # Passa args de build se necessário (geralmente para o Next.js "baker" variáveis)
          build-args: |
            NEXT_PUBLIC_API_URL=http://localhost:3001
          # Cache separado para o frontend
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend